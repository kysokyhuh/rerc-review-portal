# RERC System Directory Structure

## Backend (`src/`)

```
src/
├── config/                    # Configuration and setup
│   ├── prismaClient.ts       # Prisma ORM client (database connection)
│   └── seed.ts               # Database seed script
│
├── services/                  # Business logic and external integrations
│   └── letterGenerator.ts     # DOCX letter generation for mail-merge
│
├── utils/                     # Utility functions
│   └── slaUtils.ts           # Working-day calculation (Mon-Fri SLA math)
│
├── routes/                    # API route handlers (empty, can be expanded)
│
├── types/                     # TypeScript type definitions (empty, can be expanded)
│
├── generated/                 # Auto-generated by Prisma (do not edit)
│   └── prisma/               # Prisma client types and models
│
├── server.ts                 # Main Express app and all route definitions
└── README.md                 # Backend documentation
```

### Key Files

- **server.ts** (1900+ lines)
  - All Express routes (dashboard, projects, submissions, reviews, mail-merge, exports)
  - Endpoint definitions: `GET /health`, `GET /dashboard/queues`, `POST /projects`, etc.
  - CSV and DOCX generation logic

- **config/prismaClient.ts**
  - Prisma ORM client singleton
  - Database connection pooling

- **config/seed.ts**
  - Sample data for development and testing
  - Populates: Users, Committees, Projects, Submissions, Classifications, Reviews

- **services/letterGenerator.ts**
  - Generates DOCX files for acknowledgement and approval letters
  - Uses `docx` library to create Word documents
  - Called by `/letters/initial-ack/:id.docx` and `/letters/initial-approval/:id.docx`

- **utils/slaUtils.ts**
  - `workingDaysBetween(start, end)`: Calculates Mon-Fri business days
  - Used for SLA tracking and deadline calculations

---

## Frontend (`frontend/`)

```
frontend/
├── src/
│   ├── components/            # React components
│   │   ├── SummaryCards.tsx  # 4-card dashboard metrics (For Classification, etc.)
│   │   ├── QueueTable.tsx    # Reusable table for queue views
│   │   └── Timeline.tsx      # Status history timeline visualization
│   │
│   ├── pages/                 # Full page components (routed)
│   │   ├── DashboardPage.tsx # Main queue view (3 tables + summary)
│   │   └── ProjectDetailPage.tsx # Project detail + submission info + exports
│   │
│   ├── hooks/                 # Custom React hooks
│   │   ├── useDashboardQueues.ts # Fetches queue data with 30s auto-refresh
│   │   └── useProjectDetail.ts   # Fetches project detail with error handling
│   │
│   ├── services/              # API client and business logic
│   │   └── api.ts             # Axios client, API methods, TypeScript interfaces
│   │
│   ├── styles/                # CSS styling
│   │   └── globals.css        # All component and layout styles
│   │
│   ├── App.tsx               # Router setup and main app shell
│   └── main.tsx              # React DOM entry point
│
├── public/                   # Static assets
├── vite.config.ts            # Vite dev server configuration
├── tsconfig.json             # TypeScript settings
├── index.html                # HTML entry point
└── package.json              # Dependencies and scripts
```

### Key Files

- **App.tsx**
  - React Router setup with routes: `/dashboard`, `/projects/:projectId`
  - Root navigation with "RERC Review Portal" header

- **pages/DashboardPage.tsx**
  - Fetches queue data via `useDashboardQueues()` hook
  - Displays 4 summary cards + 3 queue tables (Classification, Review, Revision)
  - Auto-refreshes every 30 seconds

- **pages/ProjectDetailPage.tsx**
  - Fetches project detail via `useProjectDetail()` hook
  - Shows project info, submission details, status timeline
  - Export buttons: "Download Initial Acknowledgement (CSV)" and "Download Approval Letter (DOCX)"

- **services/api.ts**
  - Axios instance with auth token injection
  - Methods: `fetchDashboardQueues()`, `fetchProjectDetail()`, `exportInitialAckCSV()`, `exportInitialApprovalDocx()`
  - TypeScript interfaces for all API response types

- **hooks/useDashboardQueues.ts**
  - Custom hook that fetches `/dashboard/queues` endpoint
  - Handles loading, error states
  - Auto-refreshes every 30 seconds

---

## Tests (`tests/`)

```
tests/
├── unit/                      # Unit tests
│   └── workingDays.test.ts   # 10 tests for SLA working-day math
│
├── integration/               # Integration tests (require test DB)
│   └── schemaIntegrity.test.ts # 15 tests for schema constraints and FK validation
│
├── api/                       # API endpoint tests (require test DB)
│   ├── projects.test.ts
│   ├── submissions.test.ts
│   ├── classifications.test.ts
│   ├── reviews.test.ts
│   ├── security.test.ts       # RBAC, IDOR prevention
│   └── export6b.test.ts       # CSV export golden file tests
│
├── helpers/
│   └── prismaCleanup.ts      # Database cleanup utilities for tests
│
├── fixtures/                  # Test data (empty, can be expanded)
│
├── jest.setup.ts             # Jest configuration and setup
└── jest.config.js            # Jest config file
```

### Test Files

- **tests/unit/workingDays.test.ts** ✅
  - 10/10 tests **PASSING**
  - Tests Mon-Fri working-day calculation logic
  - Validates SLA math edge cases

- **tests/integration/schemaIntegrity.test.ts**
  - 15 tests for Prisma schema constraints
  - Tests uniqueness, foreign keys, cascades
  - Requires: PostgreSQL `rerc_test` database

- **tests/api/*.test.ts**
  - 6 test files covering all major endpoints
  - RBAC authorization, IDOR prevention, workflow correctness
  - Requires: PostgreSQL `rerc_test` database

---

## Root Level Files

```
rerc-system/
├── package.json              # Root dependencies (backend packages)
├── tsconfig.json             # TypeScript config (src + tests)
├── jest.config.js            # Jest test runner config
├── prisma/                   # Prisma schema and migrations
│   ├── schema.prisma         # 12 database models
│   └── migrations/           # Database migration history
├── .env                      # Environment variables (DATABASE_URL, etc.)
├── .gitignore                # Git ignore rules
├── README.md                 # Project overview
├── DIRECTORY_STRUCTURE.md    # This file
├── DATA_DICTIONARY.md        # Data model documentation + ERD
├── QA_TEST_STRATEGY.md       # 200+ test case specifications
└── public/                   # Static assets served by backend
```

---

## Development Commands

```bash
# Backend
npm install              # Install root dependencies
npm run dev             # Start Express dev server (localhost:3000)
npm run build           # Compile TypeScript to dist/
npm run seed            # Populate database with sample data

# Frontend
cd frontend
npm install             # Install frontend dependencies
npm run dev             # Start Vite dev server (localhost:5173)
npm run build           # Build for production

# Tests
npm run test:unit       # Run unit tests (10/10 passing)
npm run test:integration # Run integration tests (requires test DB)
npm run test:api        # Run API tests (requires test DB)
npm test                # Run all tests
```

---

## Architecture Diagram

```
┌──────────────────────────────────────────────┐
│         Frontend (React + Vite)              │
│  http://localhost:5173                       │
│  ┌──────────────────────────────────────────┤
│  │ Pages: DashboardPage, ProjectDetailPage   │
│  │ Components: SummaryCards, QueueTable      │
│  │ Hooks: useDashboardQueues, useProject...  │
│  │ Services: api.ts (Axios client)           │
│  │ Styles: globals.css                       │
│  └──────────────────────────────────────────┘
└──────────────────┬───────────────────────────┘
                   │ HTTP/JSON
┌──────────────────┴───────────────────────────┐
│    Backend (Express + Prisma)                │
│  http://localhost:3000                       │
│  ┌──────────────────────────────────────────┤
│  │ server.ts: All routes                     │
│  │ - GET /dashboard/queues                   │
│  │ - GET /projects/:id/full                  │
│  │ - POST /projects (create)                 │
│  │ - GET /mail-merge/initial-ack/:id/csv     │
│  │ - GET /letters/initial-ack/:id.docx       │
│  │ - GET /letters/initial-approval/:id.docx  │
│  │ Services: letterGenerator.ts              │
│  │ Utils: slaUtils.ts                        │
│  │ Config: prismaClient.ts, seed.ts          │
│  └──────────────────────────────────────────┘
└──────────────────┬───────────────────────────┘
                   │ SQL
┌──────────────────┴───────────────────────────┐
│      Database (PostgreSQL)                   │
│      rerc_db (or rerc_test)                  │
│  ┌──────────────────────────────────────────┤
│  │ 12 Models:                                │
│  │ Project, Submission, Classification,      │
│  │ Review, SubmissionStatusHistory,          │
│  │ Committee, Panel, PanelMember, User, etc. │
│  └──────────────────────────────────────────┘
└──────────────────────────────────────────────┘
```

---

## Best Practices

1. **Backend (src/)**
   - Add new business logic to `services/` directory
   - Add utility functions to `utils/` directory
   - Create new route groups in `routes/` directory
   - Keep `server.ts` for main app setup and simple routes

2. **Frontend (frontend/src/)**
   - One component per file in `components/`
   - Full pages in `pages/` (routed)
   - Reusable logic in `hooks/`
   - All API calls through `services/api.ts`

3. **Tests**
   - Unit tests in `tests/unit/` (no DB required)
   - Integration tests in `tests/integration/` (requires test DB)
   - API tests in `tests/api/` (requires test DB)
   - Use `tests/helpers/prismaCleanup.ts` for test cleanup

