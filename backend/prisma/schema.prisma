// prisma/schema.prisma

generator client {
  provider = "prisma-client"
  // Generate the client into src/generated/prisma
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---

enum RoleType {
  CHAIR
  MEMBER
  RESEARCH_ASSOCIATE
  RESEARCH_ASSISTANT
  REVIEWER
  ADMIN
}

enum FundingType {
  INTERNAL
  EXTERNAL
  SELF_FUNDED
  NO_FUNDING
}

enum SubmissionType {
  INITIAL
  RESUBMISSION
  AMENDMENT
  CONTINUING_REVIEW
  FINAL_REPORT
  WITHDRAWAL
  SAFETY_REPORT
  PROTOCOL_DEVIATION
}

enum ProjectStatus {
  DRAFT // encoding in progress
  ACTIVE // approved & within validity
  INACTIVE // lapsed / no ongoing activity
  WITHDRAWN // formally withdrawn
  CLOSED // final report accepted / archive
}

enum CompletenessStatus {
  COMPLETE
  MINOR_MISSING
  MAJOR_MISSING
  MISSING_SIGNATURES
  OTHER
}

enum ReviewType {
  EXEMPT
  EXPEDITED
  FULL_BOARD
}

enum ReviewDecision {
  APPROVED
  MINOR_REVISIONS
  MAJOR_REVISIONS
  DISAPPROVED
  INFO_ONLY
}

enum SubmissionStatus {
  RECEIVED
  UNDER_COMPLETENESS_CHECK
  AWAITING_CLASSIFICATION
  UNDER_CLASSIFICATION
  CLASSIFIED
  UNDER_REVIEW
  AWAITING_REVISIONS
  REVISION_SUBMITTED
  CLOSED
  WITHDRAWN
}

enum SLAStage {
  CLASSIFICATION
  REVIEW
  REVISION_RESPONSE
  CONTINUING_REVIEW_DUE
  FINAL_REPORT_DUE
  MEMBERSHIP
  MEETING
}

enum PanelMemberRole {
  CHAIR
  MEMBER
  SECRETARIAT
}

enum ResearchTypePHREB {
  BIOMEDICAL
  SOCIAL_BEHAVIORAL
  PUBLIC_HEALTH
  CLINICAL_TRIAL
  EPIDEMIOLOGICAL
  OTHER
}

enum ReviewerRoleType {
  SCIENTIST
  LAY
  INDEPENDENT_CONSULTANT
}

enum HonorariumStatus {
  PENDING
  PROCESSING
  PAID
  NOT_APPLICABLE
}

enum EndorsementStatus {
  PENDING
  RECEIVED
  WAIVED
  NOT_REQUIRED
}

enum ProjectMemberRole {
  PI
  CO_PI
  CO_INVESTIGATOR
  RESEARCH_ASSISTANT
  STATISTICIAN
  OTHER
}

enum SubmissionDocumentType {
  INFORMED_CONSENT
  DATA_GATHERING_INSTRUMENT
  MATERIAL_TRANSFER_AGREEMENT
  PERMISSION_LETTER
  OTHER
}

enum SubmissionDocumentStatus {
  MISSING
  PENDING
  RECEIVED
  REVIEWED
}

enum LetterDraftStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
}

enum WorkflowEventType {
  APPLICATION_SUBMITTED
  PANEL_ASSIGNED
  REVIEWERS_ASSIGNED
  CLASSIFICATION_DONE
  DOCUMENTS_TO_REVIEWER
  ASSESSMENT_FORMS_COMPLETED
  REVIEW_SUBMITTED
  FULL_REVIEW_MEETING
  REVIEW_RESULTS_FINALIZED
  RESULTS_COMMUNICATED
  RESUBMISSION_RECEIVED
  RESUBMISSION_REVIEWED
  RESUBMISSION_FINALIZED
  DECISION_ISSUED
  CONTINUING_REVIEW_DUE
  FINAL_REPORT_DUE
}

enum ClassificationType {
  EXEMPT
  EXPEDITED
  FULL_BOARD
}

enum ReviewerRoundRole {
  SCIENTIFIC
  LAY
}

enum DecisionStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

enum ProponentCategory {
  UNDERGRAD
  GRAD
  FACULTY
  OTHER
}

// --- MODELS ---

model User {
  id                     Int       @id @default(autoincrement())
  email                  String    @unique
  fullName               String
  passwordHash           String?
  passwordResetToken     String?
  passwordResetExpiresAt DateTime?
  lastLoginAt            DateTime?
  lastLoginIp            String?
  isCommonReviewer       Boolean   @default(false)
  reviewerExpertise      String[]  @default([])
  isActive               Boolean   @default(true)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // relations
  committeeMemberships            CommitteeMember[]
  projectsCreated                 Project[]                 @relation("ProjectsCreated")
  submissionsCreated              Submission[]              @relation("SubmissionsCreated")
  classificationsMade             Classification[]          @relation("ClassificationsClassified")
  reviewsAssigned                 Review[]                  @relation("UserReviews")
  statusChanges                   SubmissionStatusHistory[] @relation("SubmissionStatusChanges")
  panelMemberships                PanelMember[]
  assignedSubmissions             Submission[]              @relation("SubmissionStaff")
  projectChanges                  ProjectChangeLog[]        @relation("ProjectChangeLogChangedBy")
  submissionChanges               SubmissionChangeLog[]     @relation("SubmissionChangeLogChangedBy")
  letterDraftsGenerated           LetterDraft[]             @relation("LetterDraftGeneratedBy")
  letterDraftsApproved            LetterDraft[]             @relation("LetterDraftApprovedBy")
  projectSnapshotsChanged         ProjectSnapshot[]         @relation("ProjectSnapshotChangedBy")
  classificationDecisionsRecorded ClassificationDecision[]  @relation("ClassificationDecisionRecordedBy")
  reviewAssignments               ReviewAssignment[]        @relation("AssignmentReviewer")
  projectStatusHistories          ProjectStatusHistory[]
}

model Committee {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   @unique // e.g. "RERC-HUMAN"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  panels                  Panel[]
  projects                Project[]
  members                 CommitteeMember[]
  configSlas              ConfigSLA[]
  contractPeriods         ContractPeriod[]
  classificationDecisions ClassificationDecision[]
}

model Panel {
  id          Int       @id @default(autoincrement())
  committee   Committee @relation(fields: [committeeId], references: [id])
  committeeId Int
  name        String // e.g. "Panel 1"
  code        String? // optional short code
  isActive    Boolean   @default(true)

  // later: full-board assignments; for now we keep no relations here
  classifications Classification[] @relation("PanelClassifications")
  members         PanelMember[]
}

model CommitteeMember {
  id                  Int                  @id @default(autoincrement())
  committee           Committee            @relation(fields: [committeeId], references: [id])
  committeeId         Int
  user                User                 @relation(fields: [userId], references: [id])
  userId              Int
  role                RoleType
  isPrimary           Boolean              @default(false) // e.g. primary chair / primary RA
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  classificationVotes ClassificationVote[]

  @@unique([committeeId, userId, role])
}

model Project {
  id                     Int                @id @default(autoincrement())
  projectCode            String?            @unique // e.g. "2025-350"
  title                  String
  piName                 String
  piSurname              String?
  piAffiliation          String? // College
  collegeOrUnit          String? // reporting dimension for college/service unit
  proponentCategory      ProponentCategory?
  department             String? // Department
  proponent              String? // Proponent (if different from PI)
  keywords               String[]           @default([])
  researchTypePHREB      ResearchTypePHREB?
  researchTypePHREBOther String? // For "Other" specification
  fundingType            FundingType
  initialSubmissionDate  DateTime?
  proposedStartDate      DateTime?
  proposedEndDate        DateTime?
  committee              Committee          @relation(fields: [committeeId], references: [id])
  committeeId            Int
  overallStatus          ProjectStatus      @default(DRAFT)
  approvalStartDate      DateTime?
  approvalEndDate        DateTime?
  isArchived             Boolean            @default(false)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  // relations
  snapshots     ProjectSnapshot[]
  statusHistory ProjectStatusHistory[]
  submissions   Submission[]
  proponents    ProjectProponent[]
  members       ProjectMember[]
  changeLog     ProjectChangeLog[]
  createdBy     User?                  @relation("ProjectsCreated", fields: [createdById], references: [id])
  createdById   Int?
}

model AcademicTerm {
  id           Int      @id @default(autoincrement())
  academicYear String // e.g. "2025-2026"
  term         Int // e.g. 1,2,3
  startDate    DateTime
  endDate      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([academicYear, term])
  @@index([academicYear])
}

model Proponent {
  id          Int      @id @default(autoincrement())
  printedName String
  signature   String?
  email       String?
  affiliation String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projects ProjectProponent[]
}

model ProjectProponent {
  id          Int       @id @default(autoincrement())
  project     Project   @relation(fields: [projectId], references: [id])
  projectId   Int
  proponent   Proponent @relation(fields: [proponentId], references: [id])
  proponentId Int
  role        String?
  createdAt   DateTime  @default(now())

  @@unique([projectId, proponentId])
}

model ProjectMember {
  id          Int               @id @default(autoincrement())
  project     Project           @relation(fields: [projectId], references: [id])
  projectId   Int
  fullName    String
  role        ProjectMemberRole
  email       String?
  affiliation String?
  createdAt   DateTime          @default(now())
}

model ProjectChangeLog {
  id                 Int         @id @default(autoincrement())
  project            Project     @relation(fields: [projectId], references: [id])
  projectId          Int
  fieldName          String
  oldValue           String?
  newValue           String?
  reason             String?
  sourceSubmission   Submission? @relation(fields: [sourceSubmissionId], references: [id])
  sourceSubmissionId Int?
  changedBy          User?       @relation("ProjectChangeLogChangedBy", fields: [changedById], references: [id])
  changedById        Int?
  createdAt          DateTime    @default(now())

  @@index([projectId])
}

model ProjectSnapshot {
  id                     Int                @id @default(autoincrement())
  project                Project            @relation(fields: [projectId], references: [id])
  projectId              Int
  projectCode            String?
  title                  String
  piName                 String
  piSurname              String?
  piAffiliation          String?
  department             String?
  proponent              String?
  fundingType            FundingType
  researchTypePHREB      ResearchTypePHREB?
  researchTypePHREBOther String?
  initialSubmissionDate  DateTime?
  proposedStartDate      DateTime?
  proposedEndDate        DateTime?
  effectiveFrom          DateTime           @default(now())
  effectiveTo            DateTime?
  reason                 String?
  changedBy              User?              @relation("ProjectSnapshotChangedBy", fields: [changedById], references: [id])
  changedById            Int?

  @@index([projectId])
}

model Submission {
  id                      Int                @id @default(autoincrement())
  project                 Project?           @relation(fields: [projectId], references: [id])
  projectId               Int?
  submissionType          SubmissionType
  sequenceNumber          Int                @default(1) // 1 = initial, higher for follow-ups
  receivedDate            DateTime
  documentLink            String? // e.g. Google Drive folder URL
  completenessStatus      CompletenessStatus @default(COMPLETE)
  completenessRemarks     String?
  status                  SubmissionStatus   @default(RECEIVED)
  revisionDueDate         DateTime?
  continuingReviewDueDate DateTime?
  finalReportDueDate      DateTime?
  finalDecision           ReviewDecision?
  finalDecisionDate       DateTime?
  remarks                 String? // General remarks
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  createdBy       User? @relation("SubmissionsCreated", fields: [createdById], references: [id])
  createdById     Int?
  staffInCharge   User? @relation("SubmissionStaff", fields: [staffInChargeId], references: [id])
  staffInChargeId Int?

  classification         Classification?
  classificationDecision ClassificationDecision?
  reviews                Review[]
  reviewAssignments      ReviewAssignment[]
  decision               SubmissionDecision?
  documents              SubmissionDocument[]
  letterDrafts           LetterDraft[]
  workflowEvents         WorkflowEvent[]
  statusHistory          SubmissionStatusHistory[]
  projectChangeLogs      ProjectChangeLog[]
  changeLogs             SubmissionChangeLog[]
  classificationVotes    ClassificationVote[]

  @@unique([projectId, sequenceNumber])
  @@index([projectId, submissionType])
}

model SubmissionChangeLog {
  id           Int        @id @default(autoincrement())
  submission   Submission @relation(fields: [submissionId], references: [id])
  submissionId Int
  fieldName    String
  oldValue     String?
  newValue     String?
  reason       String?
  changedBy    User?      @relation("SubmissionChangeLogChangedBy", fields: [changedById], references: [id])
  changedById  Int?
  createdAt    DateTime   @default(now())

  @@index([submissionId])
}

model Classification {
  id                   Int        @id @default(autoincrement())
  submission           Submission @relation(fields: [submissionId], references: [id])
  submissionId         Int        @unique
  reviewType           ReviewType
  classificationDate   DateTime
  panel                Panel?     @relation("PanelClassifications", fields: [panelId], references: [id])
  panelId              Int?
  rationale            String? // notes / reason for classification
  missingDocuments     String[]   @default([])
  clarificationsNeeded String[]   @default([])
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  classifiedBy   User? @relation("ClassificationsClassified", fields: [classifiedById], references: [id])
  classifiedById Int?
}

model ClassificationDecision {
  id             Int                @id @default(autoincrement())
  submission     Submission         @relation(fields: [submissionId], references: [id])
  submissionId   Int                @unique
  committee      Committee          @relation(fields: [committeeId], references: [id])
  committeeId    Int
  classification ClassificationType
  decidedAt      DateTime           @default(now())
  recordedBy     User?              @relation("ClassificationDecisionRecordedBy", fields: [recordedById], references: [id])
  recordedById   Int?
  notes          String?

  votes ClassificationVote[]
}

model ClassificationVote {
  id                       Int                     @id @default(autoincrement())
  submission               Submission              @relation(fields: [submissionId], references: [id])
  submissionId             Int
  committeeMember          CommitteeMember         @relation(fields: [committeeMemberId], references: [id])
  committeeMemberId        Int
  classification           ClassificationType
  votedAt                  DateTime                @default(now())
  remarks                  String?
  classificationDecision   ClassificationDecision? @relation(fields: [classificationDecisionId], references: [id])
  classificationDecisionId Int?

  @@unique([submissionId, committeeMemberId])
  @@index([committeeMemberId])
}

model SubmissionStatusHistory {
  id            Int               @id @default(autoincrement())
  submission    Submission        @relation(fields: [submissionId], references: [id])
  submissionId  Int
  oldStatus     SubmissionStatus?
  newStatus     SubmissionStatus
  effectiveDate DateTime          @default(now())
  reason        String?
  changedBy     User?             @relation("SubmissionStatusChanges", fields: [changedById], references: [id])
  changedById   Int?
  createdAt     DateTime          @default(now())
}

model ProjectStatusHistory {
  id            Int            @id @default(autoincrement())
  project       Project        @relation(fields: [projectId], references: [id])
  projectId     Int
  oldStatus     ProjectStatus?
  newStatus     ProjectStatus
  effectiveDate DateTime       @default(now())
  reason        String?
  changedBy     User?          @relation(fields: [changedById], references: [id])
  changedById   Int?
  createdAt     DateTime       @default(now())

  @@index([projectId])
}

model Review {
  id           Int        @id @default(autoincrement())
  submission   Submission @relation(fields: [submissionId], references: [id])
  submissionId Int
  reviewer     User       @relation("UserReviews", fields: [reviewerId], references: [id])
  reviewerId   Int

  isPrimary        Boolean           @default(false)
  reviewerRole     ReviewerRoleType? // Scientist, Lay, Independent Consultant
  honorariumStatus HonorariumStatus  @default(NOT_APPLICABLE)

  assignedAt            DateTime           @default(now())
  receivedAt            DateTime?
  dueDate               DateTime?
  respondedAt           DateTime?
  endorsementStatus     EndorsementStatus?
  endorsementReceivedAt DateTime?

  decision ReviewDecision?
  remarks  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([submissionId, reviewerId])
  @@index([submissionId])
}

model ReviewAssignment {
  id                Int                @id @default(autoincrement())
  submission        Submission         @relation(fields: [submissionId], references: [id])
  submissionId      Int
  roundSequence     Int                @default(1)
  reviewer          User               @relation("AssignmentReviewer", fields: [reviewerId], references: [id])
  reviewerId        Int
  reviewerRole      ReviewerRoundRole
  assignedAt        DateTime           @default(now())
  dueDate           DateTime?
  receivedAt        DateTime?
  submittedAt       DateTime?
  decision          ReviewDecision?
  endorsementStatus EndorsementStatus?
  remarks           String?
  isActive          Boolean            @default(true)
  endedAt           DateTime?

  @@unique([submissionId, roundSequence, reviewerRole])
  @@index([submissionId, roundSequence])
  @@index([reviewerId])
}

model SubmissionDocument {
  id           Int                      @id @default(autoincrement())
  submission   Submission               @relation(fields: [submissionId], references: [id])
  submissionId Int
  type         SubmissionDocumentType
  title        String
  status       SubmissionDocumentStatus @default(PENDING)
  documentUrl  String?
  notes        String?
  receivedAt   DateTime?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  @@index([submissionId, type])
}

model SubmissionDecision {
  id           Int            @id @default(autoincrement())
  submission   Submission     @relation(fields: [submissionId], references: [id])
  submissionId Int            @unique
  decision     ReviewDecision
  decidedAt    DateTime       @default(now())
  validFrom    DateTime?
  validTo      DateTime?
  status       DecisionStatus @default(ACTIVE)
  notes        String?
}

model Holiday {
  id        Int      @id @default(autoincrement())
  date      DateTime @unique
  name      String
  createdAt DateTime @default(now())
}

model LetterDraft {
  id            Int               @id @default(autoincrement())
  submission    Submission        @relation(fields: [submissionId], references: [id])
  submissionId  Int
  templateCode  String
  status        LetterDraftStatus @default(DRAFT)
  content       Json?
  fileUrl       String?
  notes         String?
  generatedBy   User?             @relation("LetterDraftGeneratedBy", fields: [generatedById], references: [id])
  generatedById Int?
  approvedBy    User?             @relation("LetterDraftApprovedBy", fields: [approvedById], references: [id])
  approvedById  Int?
  approvedAt    DateTime?
  sentAt        DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([submissionId, status])
}

model ContractPeriod {
  id          Int        @id @default(autoincrement())
  committee   Committee? @relation(fields: [committeeId], references: [id])
  committeeId Int?
  name        String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
}

model PanelMember {
  id        Int             @id @default(autoincrement())
  panelId   Int
  userId    Int
  role      PanelMemberRole
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())

  panel Panel @relation(fields: [panelId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([panelId, userId])
}

model ConfigSLA {
  id          Int         @id @default(autoincrement())
  committee   Committee   @relation(fields: [committeeId], references: [id])
  committeeId Int
  reviewType  ReviewType?
  stage       SLAStage
  workingDays Int
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// Tracks granular workflow events/stages for each submission
// Maps to CSV columns like "Provision of Documents", "Assessment Forms Completed", etc.
model WorkflowEvent {
  id               Int               @id @default(autoincrement())
  submission       Submission        @relation(fields: [submissionId], references: [id])
  submissionId     Int
  eventType        WorkflowEventType
  cycleNumber      Int               @default(1) // 1 = initial, 2 = 1st resubmission, 3 = 2nd resubmission, etc.
  eventDate        DateTime
  daysFromPrevious Int? // # days from previous event
  remarks          String?
  createdAt        DateTime          @default(now())

  @@unique([submissionId, eventType, cycleNumber])
  @@index([submissionId, eventType])
}
