<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>RERC – RA Dashboard</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <h1>RERC – RA Dashboard</h1>
    <div class="subtitle">
      Committee: <strong>RERC-HUMAN</strong> &bull; Queues powered by your API
    </div>

    <div class="counts">
      <div class="card">
        <h2>For Classification</h2>
        <div class="number" id="count-classification">0</div>
      </div>
      <div class="card">
        <h2>Under Review</h2>
        <div class="number" id="count-review">0</div>
      </div>
      <div class="card">
        <h2>Awaiting Revisions</h2>
        <div class="number" id="count-revision">0</div>
      </div>
    </div>

    <div class="queues">
      <div class="card">
        <h2>Classification Queue</h2>
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Title</th>
              <th>Type</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="table-classification"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Review Queue</h2>
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Title</th>
              <th>Type</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="table-review"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Revision Queue</h2>
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Title</th>
              <th>Type</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="table-revision"></tbody>
        </table>
      </div>
    </div>

    <div id="project-detail" style="display: none">
      <h2>Project detail</h2>
      <div id="project-detail-body"></div>
    </div>

    <script>
      async function loadQueues() {
        try {
          const response = await fetch(
            "/dashboard/queues?committeeCode=RERC-HUMAN"
          );
          const data = await response.json();

          document.getElementById("count-classification").textContent =
            data.counts.classification;
          document.getElementById("count-review").textContent =
            data.counts.review;
          document.getElementById("count-revision").textContent =
            data.counts.revision;

          const renderQueue = (rows, elementId) => {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = "";
            rows.forEach((row) => {
              const tr = document.createElement("tr");

              const codeTd = document.createElement("td");
              codeTd.textContent = row.project.projectCode;

              const titleTd = document.createElement("td");
              titleTd.textContent = row.project.title;

              const typeTd = document.createElement("td");
              const badge = document.createElement("span");
              badge.className = "badge";
              badge.textContent = row.submissionType;
              typeTd.appendChild(badge);

              const actionTd = document.createElement("td");
              const button = document.createElement("button");
              button.textContent = "View";
              button.addEventListener("click", () => showProject(row.projectId));
              actionTd.appendChild(button);

              tr.appendChild(codeTd);
              tr.appendChild(titleTd);
              tr.appendChild(typeTd);
              tr.appendChild(actionTd);
              tbody.appendChild(tr);
            });
          };

          renderQueue(data.classificationQueue, "table-classification");
          renderQueue(data.reviewQueue, "table-review");
          renderQueue(data.revisionQueue, "table-revision");
        } catch (error) {
          console.error("Failed to load queues", error);
        }
      }

      async function showProject(projectId) {
        try {
          const response = await fetch(`/projects/${projectId}/full`);
          const data = await response.json();

          const container = document.getElementById("project-detail");
          const body = document.getElementById("project-detail-body");

          const summary = {
            projectCode: data.projectCode,
            title: data.title,
            piName: data.piName,
            piAffiliation: data.piAffiliation,
            overallStatus: data.overallStatus,
            approvalStartDate: data.approvalStartDate,
            approvalEndDate: data.approvalEndDate,
            submissions: data.submissions?.map((submission) => ({
              id: submission.id,
              type: submission.submissionType,
              status: submission.status,
              receivedDate: submission.receivedDate,
              finalDecision: submission.finalDecision,
              finalDecisionDate: submission.finalDecisionDate,
            })),
          };

          body.textContent = JSON.stringify(summary, null, 2);
          container.style.display = "block";
        } catch (error) {
          console.error("Failed to load project detail", error);
        }
      }

      loadQueues();
    </script>
  </body>
</html>
